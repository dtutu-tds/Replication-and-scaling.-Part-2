# Репликация и масштабирование. Часть 2

**Студент:** Тутубалин Дмитрий

---

## Задание 1

Опишите основные преимущества использования масштабирования методами:

- активный master-сервер и пассивный репликационный slave-сервер; 
- master-сервер и несколько slave-серверов;

### Решение:

#### Активный master-сервер и пассивный репликационный slave-сервер:

**Преимущества:**
1. **Повышение отказоустойчивости** - при выходе из строя master-сервера, slave может быть быстро переведен в режим master
2. **Резервное копирование** - slave-сервер служит живой копией данных для восстановления
3. **Разгрузка master-сервера** - чтение данных можно перенести на slave, освободив master для операций записи
4. **Географическое распределение** - slave может находиться в другом регионе для снижения задержек
5. **Тестирование и аналитика** - slave можно использовать для аналитических запросов без нагрузки на production
6. **Простота настройки** - относительно простая конфигурация с одним master и одним slave

#### Master-сервер и несколько slave-серверов:

**Преимущества:**
1. **Масштабирование чтения** - несколько slave-серверов позволяют распределить нагрузку чтения
2. **Повышенная отказоустойчивость** - при выходе из строя одного slave, остальные продолжают работать
3. **Специализация slave-серверов** - разные slave можно настроить для разных типов запросов (аналитика, отчеты, кэширование)
4. **Географическое распределение** - slave-серверы в разных регионах для снижения задержек
5. **Горизонтальное масштабирование** - возможность добавления новых slave по мере роста нагрузки
6. **Балансировка нагрузки** - распределение запросов чтения между несколькими slave-серверами
7. **Изоляция аналитических запросов** - тяжелые аналитические запросы можно выполнять на отдельных slave

---

## Задание 2

Разработайте план для выполнения горизонтального и вертикального шаринга базы данных. База данных состоит из трёх таблиц: 

- пользователи, 
- книги, 
- магазины (столбцы произвольно). 

Опишите принципы построения системы и их разграничение или разбивку между базами данных.

### Решение:

#### Архитектура системы шардинга

```
┌─────────────────────────────────────────────────────────────────┐
│                    СЛОЙ ПРИЛОЖЕНИЙ                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Сервис    │  │   Сервис    │  │   Сервис    │              │
│  │ Пользователи│  │   Книги     │  │  Магазины   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    МАРШРУТИЗАТОР ШАРДИНГА                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              Маршрутизатор по ключу шарда                   │ │
│  │  • ID пользователя → Шард 1, 2, 3                          │ │
│  │  • ID книги → Шард 1, 2, 3                                 │ │
│  │  • ID магазина → Шард 1, 2, 3                              │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│    ШАРД 1      │ │    ШАРД 2      │ │    ШАРД 3      │
│                 │ │                 │ │                 │
│ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │
│ │ Пользователи│ │ │ │ Пользователи│ │ │ │ Пользователи│ │
│ │   Таблица   │ │ │ │   Таблица   │ │ │   Таблица   │ │
│ └─────────────┘ │ │ └─────────────┘ │ │ └─────────────┘ │
│ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │
│ │   Книги     │ │ │ │   Книги     │ │ │ │   Книги     │ │
│ │   Таблица   │ │ │ │   Таблица   │ │ │ │   Таблица   │ │
│ └─────────────┘ │ │ └─────────────┘ │ │ └─────────────┘ │
│ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │
│ │  Магазины   │ │ │ │  Магазины   │ │ │ │  Магазины   │ │
│ │   Таблица   │ │ │ │   Таблица   │ │ │ │   Таблица   │ │
│ └─────────────┘ │ │ └─────────────┘ │ │ └─────────────┘ │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```


#### Принципы построения системы:

**1. Горизонтальный шардинг (Horizontal Sharding):**
- **Разделение по пользователям**: Каждый шард содержит данные определенного диапазона пользователей
- **Критерий разделения**: `user_id % 3` (для 3 шардов)
- **Независимость шардов**: Каждый шард содержит полные таблицы для своего диапазона пользователей

**2. Вертикальный шардинг (Vertical Sharding):**
- **Разделение по функциональности**:
  - **Шард 1**: Пользователи (users) - критически важные данные
  - **Шард 2**: Книги (books) - каталог товаров
  - **Шард 3**: Магазины (stores) - справочная информация

**3. Режимы работы серверов:**

| Шард | Режим | Назначение | Приоритет |
|------|-------|------------|-----------|
| Shard 1 | Master-Slave | Пользователи (критичные данные) | Высокий |
| Shard 2 | Master-Slave | Книги (каталог) | Средний |
| Shard 3 | Read-Only Replica | Магазины (справочник) | Низкий |

**4. Схема данных:**

```sql
-- Шард 1: Пользователи
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    created_at TIMESTAMP,
    shard_key INT GENERATED ALWAYS AS (id % 3) STORED
);

-- Шард 2: Книги  
CREATE TABLE books (
    id BIGINT PRIMARY KEY,
    title VARCHAR(200),
    author VARCHAR(100),
    price DECIMAL(10,2),
    user_id BIGINT, -- Связь с пользователем
    shard_key INT GENERATED ALWAYS AS (user_id % 3) STORED
);

-- Шард 3: Магазины
CREATE TABLE stores (
    id BIGINT PRIMARY KEY,
    name VARCHAR(100),
    address TEXT,
    city VARCHAR(50),
    shard_key INT GENERATED ALWAYS AS (id % 3) STORED
);
```

**5. Стратегия маршрутизации:**
- **По user_id**: Все связанные данные пользователя в одном шарде
- **По book_id**: Книги распределяются по шардам пользователей
- **По store_id**: Магазины могут быть в любом шарде (справочные данные)

**6. Преимущества архитектуры:**
- **Локальность данных**: Все данные пользователя в одном шарде
- **Масштабируемость**: Легко добавлять новые шарды
- **Отказоустойчивость**: Независимые шарды
- **Производительность**: Параллельная обработка запросов

---

## Задание 3* (Дополнительное)

Выполните настройку выбранных методов шардинга из задания 2.

### Решение:

#### Docker конфигурация

Создан файл `docker-compose.yml` с конфигурацией для:
- **3 шарда** с MySQL серверами
- **Master-Slave репликация** для критичных данных
- **ProxySQL** для маршрутизации запросов
- **Автоматическая инициализация** схемы и данных

#### SQL скрипты

1. **`01-create-tables.sql`** - Создание таблиц с поддержкой шардинга
2. **`02-insert-sample-data.sql`** - Тестовые данные для демонстрации
3. **`03-setup-replication.sql`** - Настройка Master-Slave репликации
4. **`04-sharding-queries.sql`** - Примеры запросов для тестирования

#### Запуск системы

```bash
# Запуск всех сервисов
docker-compose up -d

# Проверка статуса
docker-compose ps

# Подключение к ProxySQL (порт 6032)
mysql -h localhost -P 6032 -u sharduser -pshardpass

# Подключение к отдельным шардам
mysql -h localhost -P 3306 -u sharduser -pshardpass  # Shard 1 Master
mysql -h localhost -P 3307 -u sharduser -pshardpass  # Shard 1 Slave
mysql -h localhost -P 3308 -u sharduser -pshardpass  # Shard 2 Master
mysql -h localhost -P 3309 -u sharduser -pshardpass  # Shard 2 Slave
mysql -h localhost -P 3310 -u sharduser -pshardpass  # Shard 3
```

#### Тестирование шардинга

```sql
-- Проверка распределения пользователей по шардам
SELECT shard_key, COUNT(*) FROM users GROUP BY shard_key;

-- Тестирование маршрутизации через ProxySQL
SELECT * FROM users WHERE id = 1;  -- Попадет в Shard 1
SELECT * FROM users WHERE id = 2;  -- Попадет в Shard 2
SELECT * FROM users WHERE id = 3;  -- Попадет в Shard 3
```

#### Архитектурные особенности

- **Горизонтальный шардинг**: Данные разделены по `user_id % 3`
- **Вертикальный шардинг**: Разные типы данных на разных серверах
- **Репликация**: Master-Slave для критичных данных
- **Маршрутизация**: ProxySQL автоматически направляет запросы
- **Отказоустойчивость**: Независимые шарды с репликацией